# 爬音阶指导与音域测定（Scale Practice & Vocal Range）详细计划（鲁棒化版｜任务 #33）

> 目标：在不新增后端依赖的前提下，交付“戴耳机+授权 → 耳机佩戴检测 → 演示（可跳过） → 爬升练习 → 下降练习 → 结果展示（最高/最低音）”的完整向导；**在判定与交互上进行鲁棒化**，让高 Jitter/Shimmer、基频波动较大的用户也能顺利完成练习并获得正向反馈。沿用项目既有风格与数据契约。

**与原计划的差异概览（本版覆盖与替换原条目）**
- 新增“**基线校准（SFF）**”与**个体波动度估计（MAD）**，以此自适应误差带与稳定窗。
- 判定采用“**voicing/稳定度门控 → 半音域判定 + 连续稳定时间**”两阶段；**不以瞬时 F0 命中为准**。
- **Jitter/Shimmer 不参与实时命中判定**（仅在总结中做趋势参考并提示其局限），避免非持续元音与起收音的误判。
- 误差容忍 **分三档（±75/±50/±30 cents）**，并根据用户波动度**自动微调**；稳定窗 **250–400ms**（动态）。
- 新增**噪声/回声自检**与**失败保护**（连续失败放宽条件/建议滑音/提示休息）。
- 默认使用 **pitchy** 进行 F0 与“清晰度（clarity）”估计；实现**PitchTracker 抽象层**，便于在生产/实验开关下切换到 **tfjs-crepe（实验）**或 pYIN（可选）。
- 保持 `isProductionReady` 分支与**数据契约不变**，仅在前端本地计算与可选事件写入。

> 参考原计划的目标、节拍/八拍流程和入口位置保持一致，但判定与交互逻辑已全面升级（见下文各节）。

---

## 1. 约束与依赖

- **模式优先**：以 `isProductionReady == true` 的生产模式为验收；开发模式逻辑保留，不删除。
- **数据契约**：严格遵循 `docs/data_structures.md` 既有事件结构；如启用保存，仅保存统计值（最高/最低 Hz、音名），不存原始音频。
- **现有依赖**：复用 `Recorder.jsx`、`QuickF0Test.jsx` 经验；默认 `pitchy@4.x`。新增 `PitchTracker` 抽象：
  - `PitchyTracker`（默认，必须实现）
  - `CrepeTracker`（实验，可选，通过 feature flag 开关）
  - `PyinTracker`（可选，作为降级路径）
- **后端**：本任务不新增后端 API 或 Lambda，若未来要与 Online Praat 联动另立任务。

---

## 2. 用户流程（Wizard）

入口、路由、八拍可视化、结果页结构与原计划一致。关键变更如下：

### Step 0｜准备与权限 + **基线校准**
- 佩戴耳机提示 → 申请麦克风权限。
- **基线校准（必做）**：引导用户用选定音节（默认 *a*）发 10–15 秒**舒适持续音**；计算：
  - **SFF**（舒适基频，中位数/四分位稳健估计）；
  - **个体波动度**（F0 MAD/四分位距）；
  - **底噪基线**（静音 RMS）、**峰值能量**；
- **起始音**：自动 = SFF 下调 2 半音（可配 1–3），或手动。

### Step 1｜耳机佩戴检测（回录/环境）
- 静音采样 1s → 播放参考音 2–3s → 分析参考频段泄漏与整体 RMS；
- 通过则继续；不通过给出“降低外放/调整佩戴/换设备”提示，并允许**兜底继续**（准确性下降）。

### Step 2（可跳过）｜演示与试做
- 八拍流程演示：1=参考、2/8=空拍、3–7=目标拍；
- 动画与倒计时一致；显示“**稳定度进度环**”（见 §4.4）。

### Step 3｜爬升练习（Ascending）
- 起点 = Step 0 产出的起始音；每循环 +1 半音；
- 每个目标拍采用**稳定窗判定**，达标 5/5 则进入下一半音，否则可重试或转入下降；
- **失败保护**：连续失败 ≥ 3 次 → 提示“放宽阈值/改用滑音辅助/休息 30–60s”。

### Step 4｜下降练习（Descending）
- 起点 = 爬升最高达标音；每循环 -1 半音；
- 判定流程同上。

### Step 5｜结果页
- 展示：最高/最低音（音名/Hz/八度）、覆盖范围（半音/八度）；
- 备注：起始音模式（自动/手动）与音节；
- 可选保存事件（仅统计值）。

---

## 3. 判定与算法（鲁棒化）

### 3.1 PitchTracker 抽象
- `usePitchTracker({strategy})` Hook：输出 `{f0Hz, cents, clarity, voiced, rms, ts}`。
- **默认** `PitchyTracker`：每 20–30ms 估计一次，提供 clarity 作为“稳定度/周期性”代理；
- **实验** `CrepeTracker`（tfjs）：鲁棒性更好但性能重，受 feature flag 控制；
- **降级** `PyinTracker`：低端设备/性能问题时启用。

### 3.2 门控（Gate）
- **能量门**：RMS > baseline + Δ（默认 +12 dB）；
- **voicing/稳定度门**：`clarity ≥ θ_v`（默认 0.6，可调）；
- 未过门控的帧**不进入判定**，UI 标注“未检测到稳定发声”。

### 3.3 半音域与**连续稳定窗**
- 误差域：以 **cents** 计算；
- **容差三档**：初级 ±75 / 中级 ±50 / 进阶 ±30 cents；
- **稳定窗**：在目标拍中**累计**满足“过门控 + 误差在容差内”的时间 ≥ **250–400 ms**（自适应，默认 300 ms）；
- **动态窗/滑音**：允许在拍开始时**宽松窗**（如 ±100 cents/200 ms），到达目标音区间后切换严格窗；

### 3.4 **个体自适应**
- 依据基线校准的 F0 波动度（MAD）动态调参：
  - MAD 高 → 容差自动上调至上限（例如从 ±50 提到 ±75），并将稳定窗延长 50–100 ms；
  - MAD 低 → 可短稳窗/收紧容差；
- 回合结束按命中率微调下一回合阈值（±10–20 cents / ±50 ms）。

### 3.5 去抖与倍频修正
- 对连续帧 cents 做中位/EMA 去抖；
- 检测相邻帧倍频/半频跳变并修正。

### 3.6 失败与健康防护
- 连续 3 次失败 → 自动弹出建议：放宽阈值、启用滑音辅助、或短休息；
- 结果页加入“练习建议”（基于失败分布与偏差统计）。

---

## 4. 音频与时序

- **BPM** 默认 84（72–100 可调）；开始前 **2 拍倒计时**；
- **八拍映射**：1=参考（不判定）、2/8=空拍、3–7=目标拍；
- **调度**：AudioContext 定时（lookahead 25ms，scheduleAhead ≈ 180ms）；
- **检测对齐**：目标拍开始后 ~100ms 开启判定，结束前留 60–100ms 缓冲；
- **UI 节流**：渲染 15–30fps，判定在 Worker/Worklet 侧累计。

---

## 5. UI/UX（与项目风格一致）

- **CentsMeter + 稳定度进度环**：显示误差与“稳定窗累计进度”；
- **成功动画**：命中后卡片轻弹与打勾；
- **设置抽屉**：容差档位、BPM、模式（上/下/往返）、音域范围（SFF±n 半音）；
- **结果卡**：命中率、平均偏差、建议练习点；**Jitter/Shimmer 仅作为趋势条**并注明“仅在持续元音下可靠”。

---

## 6. 数据与契约

- **不修改** `docs/data_structures.md`；
- 若保存事件：沿用 `self_test`（或项目约定的自测事件），`details.pitch = {maxHz, minHz}`；`notes` 标注起始音与模式。

---

## 7. 测试计划（每小改动都执行）

- **单测**：
  - 音名↔频率↔半音映射、cents 计算；
  - 稳定窗累计与门控函数；
  - 自适应阈值策略（高/低 MAD）。
- **集成/手测**：
  - 基线校准：不同噪声与波动度样例；
  - 耳机检测：通过/不通过路径与兜底继续；
  - 爬升/下降：命中、失败重试、连续失败触发保护；
  - 低性能设备：触发降级/降低刷新率；
  - `isProductionReady` true/false 行为一致（仅前端差异）。
- **兼容**：Chrome、Safari(iOS)、Firefox；移动/桌面响应式。

---

## 8. 验收标准（更新）

- 高波动样例下，**命中率较“瞬时判定”方案提升 ≥30%**；
- 基线校准产出 SFF 与 MAD，并用于自适应；
- 门控生效：低能量/低稳定帧不计入判定，UI 有“未检测到稳定发声”提示；
- 容差三档 + 个体化微调可用；
- UI 与 Tailwind 风格统一；
- 文档与注释完善，含阈值与可配置项；
- 单测+集成测试覆盖核心路径。

---

## 9. 风险与权衡

- 浏览器性能/功耗 → 降级路径与 UI 节流；
- CREPE 性能负担 → 置为实验开关，默认 pitchy；
- 设备与环境差异 → 使用相对阈值、稳定窗与半音域视图降低影响；
- CPPS 等高开销指标 → 以 clarity/自相关代理作为门控，不纳入实时评分。

---

## 10. 变更记录（相较原计划）

- 判定：由“±150 cents + 稳定≥100ms（单拍）”→ **“门控 + 自适应容差（±75/50/30）+ 稳定窗 250–400ms”**；
- 新增：**基线校准、个体自适应、失败保护、稳定度进度环**；
- 库与结构：引入 **PitchTracker 抽象**（默认 pitchy；可选 CREPE/pYIN）。
