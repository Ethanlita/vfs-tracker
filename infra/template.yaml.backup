AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  VFS-Tracker Backend Infrastructure
  
  Serverless backend for VFS (Voice Feminization Surgery) Tracker application.
  Includes Lambda functions, API Gateway, DynamoDB tables, and S3 storage.

# ============================================
# 参数定义
# ============================================
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Deployment environment

  CognitoUserPoolId:
    Type: String
    Default: us-east-1_Bz6JC9ko9
    Description: Cognito User Pool ID for authentication

  CognitoUserPoolArn:
    Type: String
    Default: arn:aws:cognito-idp:us-east-1:296821242554:userpool/us-east-1_Bz6JC9ko9
    Description: Cognito User Pool ARN

  ExistingS3BucketName:
    Type: String
    Default: vfs-tracker-objstor
    Description: Existing S3 bucket name (will not be created, only referenced)

  EcrRepositoryUri:
    Type: String
    Default: 296821242554.dkr.ecr.us-east-1.amazonaws.com/vfs-tracker-images
    Description: ECR repository URI for Python Lambda container

  ApiDomainName:
    Type: String
    Default: api.vfs-tracker.app
    Description: Custom domain name for API Gateway

  CertificateArn:
    Type: String
    Default: arn:aws:acm:us-east-1:296821242554:certificate/642286ab-3434-453d-946b-318939cd7987
    Description: ACM certificate ARN for custom domain

# ============================================
# Global Configuration
# ============================================
Globals:
  Function:
    MemorySize: 128
    Timeout: 10
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    LoggingConfig:
      LogFormat: JSON
      ApplicationLogLevel: INFO
      SystemLogLevel: WARN

  Api:
    # CORS Configuration
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'"
      MaxAge: "'600'"

# ============================================
# 资源定义
# ============================================
Resources:

  # ==========================================
  # DynamoDB Tables
  # 注意: 使用 DeletionPolicy: Retain 保护数据
  # ==========================================
  
  VoiceFemEventsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: VoiceFemEvents
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: eventId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: eventId
          KeyType: RANGE
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      Tags:
        - Key: Project
          Value: vfs-tracker
        - Key: Environment
          Value: !Ref Environment

  VoiceFemUsersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: VoiceFemUsers
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      Tags:
        - Key: Project
          Value: vfs-tracker
        - Key: Environment
          Value: !Ref Environment

  VoiceFemTestsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: VoiceFemTests
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
      Tags:
        - Key: Project
          Value: vfs-tracker
        - Key: Environment
          Value: !Ref Environment

  # ==========================================
  # IAM Role for Lambda Functions
  # ==========================================
  
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub vfs-tracker-lambda-role-${Environment}
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt VoiceFemEventsTable.Arn
                  - !GetAtt VoiceFemUsersTable.Arn
                  - !GetAtt VoiceFemTestsTable.Arn
                  - !Sub ${VoiceFemEventsTable.Arn}/index/*
                  - !Sub ${VoiceFemUsersTable.Arn}/index/*
                  - !Sub ${VoiceFemTestsTable.Arn}/index/*
        - PolicyName: DynamoDBStreamAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:DescribeStream
                  - dynamodb:ListStreams
                Resource: !GetAtt VoiceFemEventsTable.StreamArn
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${ExistingS3BucketName}
                  - !Sub arn:aws:s3:::${ExistingS3BucketName}/*
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*
      Tags:
        - Key: Project
          Value: vfs-tracker
        - Key: Environment
          Value: !Ref Environment

  # ==========================================
  # API Gateway
  # ==========================================
  
  VoiceFemApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub VoiceFemApi-${Environment}
      StageName: !Ref Environment
      Description: VFS-Tracker REST API
      EndpointConfiguration:
        Type: EDGE
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !Ref CognitoUserPoolArn
            Identity:
              Header: Authorization
      Tags:
        Project: vfs-tracker
        Environment: !Ref Environment

  # ==========================================
  # Lambda Functions - Events
  # ==========================================

  AddVoiceEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub addVoiceEvent-${Environment}
      Description: Add a new voice event
      CodeUri: ../lambda-functions/addVoiceEvent/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          EVENTS_TABLE: !Ref VoiceFemEventsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /events
            Method: POST

  GetVoiceEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getVoiceEvents-${Environment}
      Description: Get voice events for a user
      CodeUri: ../lambda-functions/getVoiceEvents/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          EVENTS_TABLE: !Ref VoiceFemEventsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /events/{userId}
            Method: GET

  GetAllPublicEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getAllPublicEvents-${Environment}
      Description: Get all public events (no auth required)
      CodeUri: ../lambda-functions/getAllPublicEvents/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 3008
      Timeout: 29
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          EVENTS_TABLE: !Ref VoiceFemEventsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /all-events
            Method: GET
            Auth:
              Authorizer: NONE

  DeleteEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub deleteEvent-${Environment}
      Description: Delete an event
      CodeUri: ../lambda-functions/deleteEvent/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          EVENTS_TABLE: !Ref VoiceFemEventsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /event/{eventId}
            Method: DELETE

  AutoApproveEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub autoApproveEvent-${Environment}
      Description: Auto-approve events from DynamoDB Stream
      CodeUri: ../lambda-functions/autoApproveEvent/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      MemorySize: 1024
      Timeout: 300
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          EVENTS_TABLE: !Ref VoiceFemEventsTable
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt VoiceFemEventsTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 1
            Enabled: true

  # ==========================================
  # Lambda Functions - Users
  # ==========================================

  GetUserProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getUserProfile-${Environment}
      Description: Get user profile
      CodeUri: ../lambda-functions/getUserProfile/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref VoiceFemUsersTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /user/{userId}
            Method: GET

  GetUserPublicProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getUserPublicProfile-${Environment}
      Description: Get user public profile (no auth required)
      CodeUri: ../lambda-functions/getUserPublicProfile/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref VoiceFemUsersTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /user/{userId}/public
            Method: GET
            Auth:
              Authorizer: NONE

  UpdateUserProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub updateUserProfile-${Environment}
      Description: Update user profile
      CodeUri: ../lambda-functions/updateUserProfile/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref VoiceFemUsersTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /user/{userId}
            Method: PUT

  UserProfileSetupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub vfsTrackerUserProfileSetup-${Environment}
      Description: Initial user profile setup
      CodeUri: ../lambda-functions/vfsTrackerUserProfileSetup/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref VoiceFemUsersTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /user/profile-setup
            Method: POST

  # ==========================================
  # Lambda Functions - Files
  # ==========================================

  GetUploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getUploadUrl-${Environment}
      Description: Get presigned URL for file upload
      CodeUri: ../lambda-functions/getUploadUrl/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: !Ref ExistingS3BucketName
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /upload-url
            Method: POST

  GetFileUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getFileUrl-${Environment}
      Description: Get presigned URL for file download
      CodeUri: ../lambda-functions/getFileUrl/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: !Ref ExistingS3BucketName
          VOICE_TESTS_TABLE_NAME: !Ref VoiceFemTestsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /file-url
            Method: POST

  GetAvatarUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub getAvatarUrl-${Environment}
      Description: Get avatar URL for a user
      CodeUri: ../lambda-functions/getAvatarUrl/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: !Ref ExistingS3BucketName
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /avatar/{userId}
            Method: GET

  # ==========================================
  # Lambda Functions - Voice Analysis (Container)
  # ==========================================

  OnlinePraatAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub online-praat-analysis-${Environment}
      Description: Python-based voice analysis using Praat
      PackageType: Image
      ImageUri: !Sub ${EcrRepositoryUri}:latest
      MemorySize: 3008
      Timeout: 300
      Architectures:
        - arm64
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          BUCKET: !Ref ExistingS3BucketName
          DDB_TABLE: !Ref VoiceFemTestsTable
          LOG_LEVEL: INFO
          AWS_S3_US_EAST_1_REGIONAL_ENDPOINT: regional
      Events:
        CreateSession:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /sessions
            Method: POST
        UploadFile:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /uploads
            Method: POST
        Analyze:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /analyze
            Method: POST
        GetResults:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /results/{sessionId}
            Method: GET

  # ==========================================
  # Lambda Functions - Utilities
  # ==========================================

  GeminiProxyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub gemini-proxy-${Environment}
      Description: Proxy for Google Gemini API
      CodeUri: ../lambda-functions/gemini-proxy/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          # SSM Parameter Store reference - value resolved at deploy time
          GEMINI_API_KEY: '{{resolve:ssm:/vfs-tracker/gemini-api-key}}'
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /gemini-proxy
            Method: POST

  GetSongRecommendationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub get-song-recommendations-${Environment}
      Description: Get song recommendations using Gemini
      CodeUri: ../lambda-functions/get-song-recommendations/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 29
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          # SSM Parameter Store reference - value resolved at deploy time
          GEMINI_API_KEY: '{{resolve:ssm:/vfs-tracker/gemini-api-key}}'
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /recommend-songs
            Method: POST

  EdgeProbeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub edge-probe-${Environment}
      Description: Edge location probe for latency testing
      CodeUri: ../lambda-functions/edge-probe/
      Handler: index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        GetEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /edge-probe
            Method: GET
            Auth:
              Authorizer: NONE
        PostEvent:
          Type: Api
          Properties:
            RestApiId: !Ref VoiceFemApi
            Path: /edge-probe
            Method: POST
            Auth:
              Authorizer: NONE

# ============================================
# 输出
# ============================================
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${VoiceFemApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/
    Export:
      Name: !Sub ${AWS::StackName}-ApiEndpoint

  ApiId:
    Description: API Gateway ID
    Value: !Ref VoiceFemApi
    Export:
      Name: !Sub ${AWS::StackName}-ApiId

  EventsTableName:
    Description: DynamoDB Events table name
    Value: !Ref VoiceFemEventsTable
    Export:
      Name: !Sub ${AWS::StackName}-EventsTable

  UsersTableName:
    Description: DynamoDB Users table name
    Value: !Ref VoiceFemUsersTable
    Export:
      Name: !Sub ${AWS::StackName}-UsersTable

  TestsTableName:
    Description: DynamoDB Tests table name
    Value: !Ref VoiceFemTestsTable
    Export:
      Name: !Sub ${AWS::StackName}-TestsTable

  LambdaRoleArn:
    Description: Lambda execution role ARN
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-LambdaRoleArn
