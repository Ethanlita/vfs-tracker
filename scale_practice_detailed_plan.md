# 爬音阶指导与音域测定（Scale Practice & Vocal Range）详细计划

> 目标：实现交互式“戴耳机+麦克风权限→耳机佩戴检测→演示（3A，可跳过）→爬升练习（半音递进）→下降练习（半音递减）→展示结果（最高/最低音）→（可选）保存到时间轴”的完整功能。前端侧实时检测基频并判定是否达标；结果可选生成一个“自我测试（self_test）”事件写入时间轴（仅保存统计结果，不上传原始音频）。

本计划遵循以下约束和依赖：
- 生产模式优先：假定 isProductionReady == true 的生产环境。开发模式逻辑保留但不作为本任务重点。
- 数据契约：严格遵循 docs/data_structures.md（事件类型与字段）。若新增字段需向后兼容。
- 现有组件与依赖：复用 Recorder.jsx、QuickF0Test.jsx 的经验；使用 pitchy@4.1.0 做基频检测；样式遵循 Tailwind CSS 与现有 UI 风格。
- Lambda：本功能为本地交互与统计，默认不新增后端 API；可选在结束时创建事件（复用 src/api.js 的 addEvent）。Lambda 如需扩展（例如将结果并入 Online Praat 报告），需单独立项与手动部署。
- 第三方手册：实现前需根据 pitchy 与 Web Audio 的最新手册核对 API 与最佳实践（避免项目内已有文档的潜在过时问题）。

---

## 1. 需求范围与成功标准

### 1.1 必达需求（对应 TODO#33）
1) 提示用户佩戴耳机，并请求录音权限；
2) 耳机佩戴检测：播放一段音频，同时用麦克风采集并检测是否有明显回录（若有则判定未佩戴耳机或环境漏音严重）；
3A) 提供练习演示（可跳过）：要求用户选择一个发音（如 a / i / ne / mei / na），（演示目标做法并引导用户跟做一次；
3) 两次正式练习：一次爬升（每个循环提升半音）与一次下降（每个循环下降半音）；
4) 爬升起点由“起始音选择器”确定：默认为“自动推荐”（基于用户舒适持续音的 F0 中位数，下调 2 个半音作为起点）；若选择“手动”，则以用户所选音名+八度为起点。每个循环：先播放起始音，然后播放模式序列“起始音→二度→三度→二度→起始音”（例：Root–M2–M3–M2–Root），过程中录音；若用户在各目标音处达到基频阈值判定则进入下一循环，否则允许重试或跳至下降练习；用户舒适音可以参考quick-fo-test的方法来测定（或者直接复用相关组件）
5) 下降从爬升中达到的最高音开始，每次循环下降半音，序列与判定方式相同；
6) 结束后展示“最高到达音与最低到达音”（含音名与频率）；
7) 在 MyPage 的现有按钮右侧新增“音阶练习”按钮进入此向导。

### 1.2 验收标准
- 能完成耳机检测并给出清晰可理解的错误/提示信息；
- 用户在实时视觉反馈（电平/音高/偏差）与音频引导下完成爬升与下降；
- 达标判定准确且稳定，支持重试与跳过演示；
- 结果视图完整显示最高/最低音（Hz、音名、八度）与覆盖范围（半音/八度）；
- UI 风格与间距、配色符合项目既有 Tailwind 规范；
- 代码内多注释；每一步小改动后均有明确测试清单（见 §8）。

---

## 2. 用户流程与状态机（Wizard）

### 2.1 路由与入口
- 在 MyPage.jsx 的操作区域，新增“音阶练习”按钮，点击后导航至 `/scale-practice`。
- 新建 `<ScalePracticeWizard/>` 组件作为页面根组件，分多步子视图。

### 2.2 步骤定义
- Step 0｜准备与权限
  - 文案：请佩戴耳机；将请求麦克风权限；选择练习发音（默认 a，可选 i / ne / mei / na）；选择起始音模式（自动推荐/手动选择）。自动推荐：让用户发 1–2 秒“舒适持续音”，估计 F0 中位数并下调 2 个半音作为起点；手动选择：提供音名+八度选择器（范围 A2–G5）与“试听参考音”按钮。
  - 音节选择建议：
    - 初学者推荐使用“a”：开口音、谐波能量分布更均衡，F0 检测更稳定，紧张感较低。
    - 需要强调前向共鸣/清晰度可选“ne/na/mei”：有利于齿龈/鼻腔共鸣提示，但注意避免喉挤，感觉不适请切回“a”。
    - 想强化高频谐波可选“i”：可能带来紧张或过鼻，若连续未达标或不适，建议改回“a”。
    - 建议一次练习全程使用同一音节便于对比，如需切换请在结果页备注。
    - 若连续未达标或感觉吃力，系统将提示尝试改用“a”并/或下调起点。
  - 操作：点击“授予权限并开始检测”（如选择自动推荐，会在权限通过后提示采样舒适音）。

- Step 1｜耳机佩戴检测
  - 方案：播放参考音（参见 §4.3），同时采集麦克风；评估是否存在显著回录峰值（参见 §4.4）。
  - 结果：通过→进入 Step 2；未通过→提示佩戴/调整音量/换设备，可重试。

- Step 2（3A）｜演示与试做（可跳过）
  - 文案：采用“每循环 8 拍”的方式进行跟唱。拍点含义：
    - 第1拍：系统播放起始音（参考音），用户不需要跟唱；
    - 第2拍与第8拍：空拍（休止），用于换气与准备；
    - 第3–第7拍：系统播放目标音，用户与系统同步跟唱（实时显示偏差与达标状态）。
    - 默认速度 84 BPM（可在设置中调整），开始前给出 2 拍倒计时与可视化节拍指示。
  - 动画演示：显示 8 拍节拍条/圆环依次点亮，当前拍高亮；配合节拍提示音/闪烁；目标音名与频率在第3–7拍期间高亮显示。
  - 操作：播放 1 轮示范（音高序列示例：C–D–E–D–C 分别落在第3–7拍），用户跟做并实时看到偏差仪表；支持“重试一次”或“跳过演示”。

- Step 3｜爬升练习（Ascending）
  - 起点：由“起始音选择器”确定（默认自动推荐）；每个循环升高半音（+100 cents）。
  - 每循环流程（8 拍）：
    1) 第1拍播放起始音（仅参考，不判定）；第2与第8拍为空拍；第3–7拍按“起始音(根)→二度→三度→二度→根”的目标音序列播放，用户同步跟唱；
    2) 判定窗口与节拍对齐：对第3–7拍分别开启检测窗口（含 80–120ms 延迟补偿与 200–300ms 稳定期），按 §4.5 与 §4.8 的阈值规则进行达标判定；
    3) 若五处目标拍均达标→进入下一半音循环；任意失败→提供“重试本循环”或“转入下降练习”；BPM 可调整（默认 84 BPM）。
  - 终止条件：到达上限（预设上限如 G5 或设备/用户能力上限）或用户主动中止或判定连续失败（见 §4.6）。
  - 产出：记录达到的最高音（Hz/音名/八度）。

- Step 4｜下降练习（Descending）
  - 起点：爬升最高达标音；每循环下降半音；
  - 模式序列、八拍节拍与判定方式同 Step 3（第1拍参考、2与8空拍、3–7 目标拍）；
  - 终止条件：达到下限（如 A2）或用户中止；
  - 产出：记录达到的最低音。

- Step 5｜结果页
  - 展示：最高/最低音、对应频率；可选显示“覆盖范围多少半音/八度”；并标注“起始音选择（自动/手动 + 起始音名/八度）”以便复盘；
  - 操作：
    - 重新开始；
    - 返回我的页面；
    

### 2.3 状态机与可恢复性
- 核心状态：currentStep, selectedSyllable, micGranted, headphoneCheckPassed, ascendProgress, descendProgress, highestNote, lowestNote, attempts, lastFailureReason。
- 错误路径：权限拒绝（提示系统设置或重新授权）、音频设备切换、回放设备变化导致检测失败（提示重检）。

---

## 3. UI/UX 与可访问性

- 视觉风格：沿用项目按钮/卡片/间距体系（Tailwind spacing 4/6/8、圆角、阴影与棋盘式留白）。
- 关键组件：
  - 实时电平条与音高偏差仪表（Cents Meter，色彩语义：绿色=达标，橙色=接近，红色=偏差大）。
  - 目标音/当前检测音的卡片提示（音名、频率）。
  - 循环进度与半音步进显示（“当前：C4 → 下一目标：C#4”）。
  - 8 拍节拍动画（进度环或 8 拍灯条）与节拍提示音/闪烁，含 2 拍倒计时。
  - 节拍/速度设置（BPM 选择与显示），默认 84 BPM，可 72–100 BPM 调整。
- 文案与引导：对新手友好，明确“佩戴耳机是为了避免扬声器回录影响判定”。
- 可访问性：按钮有清晰标签；颜色对比度合规；动画不过度；键盘可操作。
- 响应式：移动端固定底部操作条（开始/停止/重试），桌面端右侧操作区。

---

## 4. 音频与算法设计

### 4.1 技术栈
- 录音：Web Audio + MediaDevices.getUserMedia（单声道，建议 44.1k 或 48kHz）。
- 实时分析：AnalyserNode + AudioWorklet/ScriptProcessor（优先 Worklet）→ 基于 pitchy 进行 F0 检测与平滑。
- 播放：AudioContext 生成引导音（推荐使用 AudioBuffer 的正弦/柔和波形样本，避免生硬的纯正弦；提供 10ms Attack/Release）。

### 4.2 音名与频率映射
- 参考：A4=440Hz，半音比 r = 2^(1/12)。
- 中央 C（C4）约 261.626 Hz。
- 映射函数：通过半音位移 n → f = 440 * 2^((n - 9)/12)（以 A4 为基准）；或直接从 C4 起步 n→ f = 261.626 * 2^(n/12)。
- 展示：音名（含升降号）、八度与频率保留 1–2 位小数；提供中文音名（C# → 升 C）。

### 4.3 参考音与耳机检测信号
- 耳机检测：播放 1 kHz 正弦参考 -18 dBFS，时长 2–3s（或粉噪+带通）。
- 目标音回放：引导音均为轻柔的正弦/三角波，起止做短淡入淡出。

### 4.4 耳机佩戴检测算法（泄漏检测）
- 步骤：
  1) 静默校基线：1s 采样环境噪声 RMS、频谱；
  2) 播放参考音同时录制：检测麦克风信号在参考频段（±30Hz）内的幅度峰值与基线对比；
  3) 阈值判定：若峰值-基线 < T1（如 10–15dB）且整体 RMS 未显著升高，则判为“通过”（漏音不明显）；否则“未通过”；
- 注意：移动端机内串音可能导致误判，允许用户“我已戴耳机，继续”选项，但提示“可能影响判定”。

### 4.5 达标判定（每个目标音）
- 只在用户声强高于阈值（例如相对于基线 + 12 dB）时进行基频判定；
- 使用 pitchy 检测 F0；对短窗进行稳定性检测；
- 判定规则（与现行实现一致）：
  - 振幅阈值：短窗 RMS > baseline + 12 dB（等效实现为绝对/相对双阈）
  - 音高阈值：目标频率对应的音高 ±150 cents
  - 稳定时长：目标拍内累计满足阈值不少于 100 ms
- 去抖与平滑：对 cents 偏差做中值/EMA，忽略瞬态；目标拍内以目标为参考的cents域EMA。
- 失败策略：允许本目标音二次尝试，若连续两次失败则给出“稍作休息”建议。

### 4.6 练习边界与安全
- 爬升上限建议到 G5（或 784Hz）默认上限；超过提示风险；
- 下降下限建议到 A2（110Hz）默认下限；
- 可在设置中调整上/下限以适配低声部或高声部。

### 4.7 起始音自动推荐算法（Auto）
- 采样：提示用户以选择的音节（a/i/ne/mei/na）发 1–2 秒舒适持续音；捕获音量与 F0；
- 估计：计算 F0 中位数（抗异常值），映射至最近音名（含八度）；考虑振幅阈值（基线+12 dB）过滤；
- 下调策略：为保证上行空间，将估计音名下调 2 个半音作为起点（可配置为 1–3 个半音）；
- 稳健性：若采样不稳定（cents 方差过大）或无有效 F0，则回退到 C4 并提示用户可重试或改用手动选择；
- 边界夹取：若自动结果超出 A2–G5，则夹取到边界并提示；
- 记录：在结果页与可选的事件 notes 中标注“Auto + 起始音名/八度”。

### 4.8 节拍与时序调度
- BPM：默认 84 BPM（可 72–100 调整），节拍器在用户手势后启动；开始前给 2 拍倒计时。
- 八拍映射：1=参考（不判定），2=空拍，3–7=目标拍（播放目标音并判定），8=空拍。
- 调度：使用 AudioContext 定时调度（lookahead 25ms + scheduleAheadTime ≈ 180ms），将各拍的提示音与目标音分批预安排到精确时间点；UI 动画用 requestAnimationFrame 同步当前拍高亮。
- 检测对齐：第3–7拍各自的判定窗口在该拍开始后加入约 100 ms 延迟补偿，结束前留 60–100 ms 作为缓冲；
- 误差容忍：允许音频播放与 UI 高亮之间 ≤ 40ms 的感知误差；超过阈值应在控制台告警并可选降帧 UI。
- 变速：BPM 变化只在新一循环开始时生效，避免中途更改影响当前循环的节拍一致性。

---

## 5. 组件与代码结构（前端）

> 不在此文档中提交代码；以下为实施结构建议，均需多注释并逐步测试。

- 新增页面：`src/components/ScalePracticeWizard.jsx`
  - 内含子视图组件：
    - `HeadphoneCheckStep`（耳机检测）
    - `DemonstrationStep`（演示/试做）
    - `AscendPracticeStep`（爬升练习）
    - `DescendPracticeStep`（下降练习）
    - `ResultStep`（结果页）
  - 共享子组件：
    - `CentsMeter`：显示当前与目标音的偏差，颜色与提示文案
    - `NoteBadge`：显示音名/八度/Hz
    - `PracticeControls`：开始/停止/重试/跳过按钮组
    - `StartingNoteSelector`：自动推荐/手动选择起点，手动提供音名+八度选择与“试听参考音”
- 复用与工具：
  - 复用 `Recorder.jsx` 的麦克风启动/停止逻辑（必要时抽出音频图节点管理为 util）
  - 复用 `QuickF0Test.jsx` 中的采样与稳定性经验（仅逻辑思路，避免重复）
  - 新建 `src/utils/notes.js`（音名映射、cent 计算、频率表生成）
  - 新建 `src/utils/tonePlayer.js`（引导音合成/播放/淡入出/序列播放）
- 路由：
  - 在 `App.jsx` 添加路径 `/scale-practice` → `<ScalePracticeWizard/>`
  - `MyPage.jsx` 新增入口按钮（与现有按钮风格一致，位于右侧）

---

## 6. 数据与事件写入

- 仅在本地计算最高/最低音；
- API：
  - 不需要
- 隐私：
  - 不收集用户原始语音；仅保存统计数值与时间戳（默认）
  - UI 标注隐私与本地处理说明

---

## 7. 第三方与实现前校验

- pitchy（4.1.0）：
  - 校验 API 用法（帧长、采样率期望、返回单位、稳定性建议）
  - 参考最新 README/手册，避免因版本差异导致的参数错误
  - 平滑、滤波，避免噪音导致基频乱飘
- Web Audio：
  - iOS/Safari 限制：必须在用户手势后创建/恢复 AudioContext
  - 设备选择/切换：尽量简化为“默认输入/输出”，如需设备切换后续再扩展

---

## 8. 测试计划（每次小改动后都进行）

- 单元测试（纯函数）：
  - `notes.js`：音名↔频率↔半音位移映射、cent 偏差计算
  - 稳定性判定函数（输入一段 F0 序列与振幅，输出达标/未达标）
- 手动测试：
  - 起始音选择：
    - 自动推荐：用低/中/高三类样例舒适音验证起点合理性与“下调 2 半音”策略；验证采样失败回退与提示路径；
    - 手动选择：在边界音名（A2、G5）选择后能正确夹取与提示；可“试听参考音”；
  - 八拍与节拍同步：
    - 动画与节拍提示音同步误差 < 40ms；2 拍倒计时正确；1/2/8 拍的“参考/空拍”逻辑正确；
    - 第3–7拍的目标音播放、UI 高亮、判定窗口三者时间一致，BPM 在 72–100 可调且切换在新循环生效；
  - 耳机检测通过/不通过路径；外放音量大/小对结果影响
  - 爬升练习：连续达标、单点失败并重试、连续失败转入下降
  - 下降练习：从高音起步，验证最低音记录与停止逻辑
  - 结果页：显示音域范围、单位与四舍五入，音名正确，并标注“起始音模式+音名”
  - 浏览器：Chrome（桌面/安卓）、Safari（iOS）、Firefox（桌面）
  - 响应式：320–1280px 断点，按钮触达与文案不折叠
- 性能与稳定：
  - Worklet 回调不卡顿；UI 更新节流（如 15–30 fps）
  - 音频播放与录音并行不出现明显时序问题

---

## 9. 风险与缓解

- 扬声器回录导致误判 → 耳机检测与门限设置、用户“我已佩戴耳机，继续”覆盖开关但提示准确性降低
- 移动端采样率不稳定/系统 AGC → 使用相对阈值+平滑、提示避免嘈杂环境
- 低声部/高声部极端范围 → 允许用户设置上下限或自动适配（后续增强）
- Safari/iOS 自动播放限制 → 所有音频启动需在用户手势后；AudioContext resume()
- pitchy 对嘈杂语音的鲁棒性 → 声强阈值与短窗稳定性筛选

---

## 10. UI 规范与一致性（Tailwind）

- 基础：卡片 `rounded-lg shadow-sm border bg-white/80`，容器 `max-w-3xl mx-auto p-4 sm:p-6 lg:p-8`
- 交互按钮组：主按钮 `btn-primary`（项目既有样式类），次按钮 `btn-secondary`，危险/停止 `btn-danger`
- 仪表：使用语义色（green-500 / amber-500 / rose-500），文字与背景对比度 AA
- 动画：淡入淡出 `transition-opacity duration-200`，避免持续性炫光

---

## 11. 迭代计划与里程碑（估算）

- D0：计划评审与设计冻结（本文件）
- D1–D2：音高与音名映射、CentsMeter、TonePlayer 工具（本地验证）
- D3：耳机检测实现与门限调参、Step 0–1
- D4：演示/试做与爬升步骤（Step 2–3），稳定性达标策略调优
- D5：下降步骤与结果页（Step 4–5）
- D6：入口按钮、路由；文案与样式统一
- D7：跨浏览器测试与问题修复；验收与上线
- 备注：每步实现后按 §8 测试清单验证

---

## 12. 验收清单（逐项对应 TODO#33）

- [ ] 要求佩戴耳机并请求录音权限（Step 0）
- [ ] 起始音选择器可用：自动推荐能稳定产出起点并支持失败回退；手动选择可试听且边界夹取正确（Step 0）
- [ ] 耳机佩戴检测完成并可重试（Step 1）
- [ ] 练习演示可观看与跳过，发音可选；八拍动画与文字说明清晰明了（Step 2）
- [ ] 爬升练习按 8 拍流程进行：1 拍参考、2/8 空拍、3–7 目标拍并对齐判定；达标则进入下一循环，可重试/跳转（Step 3）
- [ ] 下降练习与爬升同样的 8 拍流程与判定（Step 4）
- [ ] 结束页展示最高/最低音与频率，并标注起始音模式与音名（Step 5）
- [ ] MyPage 新增“音阶练习”入口（UI）

---

## 13. 运维与部署

- 本功能主要在前端实现，无新增后端 Lambda
- 监控与错误上报（可选）：控制台日志与轻量埋点，记录耳机检测失败率与常见错误码

---

## 14. 后续扩展（非本次必须）

- 与 Online Praat 的 VRP 联动：将本地训练的最高/最低音纳入报告或作为先验
- 上传匿名短音片段用于“机器校准”与模型改进（需额外隐私同意）
- 个性化音域目标与日常跟踪（趋势图、置信区间）

---

实现前的准备动作：
- 校对 pitchy 与 Web Audio 最新文档，确认 API、参数与兼容性；
- 对照本文件逐条分解为任务卡，逐步开发，每小步后即按 §8 执行测试；
- 确保不删除或破坏开发模式逻辑，但本功能优先按生产模式验收。
